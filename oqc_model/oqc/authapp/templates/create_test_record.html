<!DOCTYPE html>
<html>
<head>
    <title>Create Test Record</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" />
    <script>
        function handleImageOptionChange(selectElement, index) {
            var uploadDiv = document.getElementById('upload-div-' + index);
            var captureDiv = document.getElementById('capture-div-' + index);
            if (selectElement.value === 'upload') {
                uploadDiv.style.display = 'block';
                captureDiv.style.display = 'none';
            } else if (selectElement.value === 'capture') {
                uploadDiv.style.display = 'none';
                captureDiv.style.display = 'block';
                startVideo(index);
            } else {
                uploadDiv.style.display = 'none';
                captureDiv.style.display = 'none';
            }
        }

        function startVideo(index) {
            var video = document.getElementById('video-' + index);
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                });
            }
        }

        function captureImage(index, customWidth, customHeight) {
            var video = document.getElementById('video-' + index);
            var canvas = document.getElementById('canvas-' + index);
            var photosContainer = document.getElementById('photos-container-' + index);
            var context = canvas.getContext('2d');

            if (video.videoWidth && video.videoHeight) {
                var width = customWidth || video.videoWidth;
                var height = customHeight || video.videoHeight;

                canvas.width = width;
                canvas.height = height;
                context.drawImage(video, 0, 0, width, height);

                var dataURL = canvas.toDataURL('image/png');

                var img = document.createElement('img');
                img.src = dataURL;
                photosContainer.innerHTML = ''; // Clear previous images
                photosContainer.appendChild(img);

                var hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'captured_images_' + index;
                hiddenInput.value = dataURL;
                photosContainer.appendChild(hiddenInput);

                // Debug: Log the captured image data
                console.log('Captured image data:', dataURL);

                // Increment num_images value
                document.getElementById('num_images').value = index + 1;
            }
        }

        function previewImage(event, index) {
            var output = document.getElementById('output-' + index);
            output.innerHTML = '';  // Clear any existing images
            var newImg = new Image();
            newImg.src = URL.createObjectURL(event.target.files[0]);
            newImg.style.maxWidth = "100%";
            newImg.style.height = "auto";
            output.appendChild(newImg);

            // Increment num_images value
            document.getElementById('num_images').value = index + 1;
        }
    </script>
</head>
<body>
    <div class="container mt-5">
        <h1>Create Test Record</h1>
        <form method="get" action="">
            <label for="num_images_input">Number of images to upload:</label>
            <input type="number" id="num_images_input" name="num_images" min="0" value="{{ num_images }}" class="form-control" />
            <button type="submit" class="btn btn-secondary mt-2">Set</button>
        </form>
        <form id="test-record-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ report_form.as_p }}
            <input type="hidden" id="num_images" name="num_images" value="{{ num_images }}">

            {{ formset.management_form }}
            {% for form in formset %}
                <div class="form-group">
                    <label for="image-option-{{ forloop.counter0 }}">Select Image Option:</label>
                    <select id="image-option-{{ forloop.counter0 }}" class="form-control" onchange="handleImageOptionChange(this, {{ forloop.counter0 }})">
                        <option value="">Select Option</option>
                        <option value="upload">Upload Image</option>
                        <option value="capture">Capture Image</option>
                    </select>
                </div>
                <div id="upload-div-{{ forloop.counter0 }}" class="form-group" style="display: none;">
                    {{ form.image.label_tag }}<br>
                    {{ form.image }}
                    <div id="output-{{ forloop.counter0 }}" class="mt-2"></div>
                    {% if form.image.value %}
                    <img src="{{ form.image.value.url }}" alt="Uploaded Image" style="width: 50; height: 100;">
                    {% endif %}
                </div> 

                <div id="capture-div-{{ forloop.counter0 }}" class="form-group" style="display: none;">
                    <video id="video-{{ forloop.counter0 }}" width="100" height="100" autoplay></video><br>
                    <canvas id="canvas-{{ forloop.counter0 }}" width="100" height="100" style="display: none;"></canvas><br>
                    <button type="button" class="btn btn-primary" onclick="captureImage({{ forloop.counter0 }}, 150, 150)">Capture Image</button>
                    <div id="photos-container-{{ forloop.counter0 }}"></div>
                </div>
            {% endfor %}

            <button type="submit" class="btn btn-primary">Save</button>
        </form>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Attach event listeners to all file inputs for image preview
            document.querySelectorAll('input[type="file"]').forEach((input, index) => {
                input.addEventListener('change', function(event) {
                    previewImage(event, index);
                });
            });
        });
    </script>
</body>
</html>
